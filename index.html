
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ruleta</title>
  <style>
    :root{
      --pink:#ff2f92;
      --pink2:#ff6fb1;
      --bg1:#ff9acb;
      --bg2:#ff5fa2;
      --card:#ffffff;
      --text:#1b1b1b;
      --muted:#6b6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 20% 10%, rgba(255,255,255,.35), transparent 60%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      color:var(--text);
    }
    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .app{grid-template-columns: 1fr;}
    }
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .pad{padding:16px;}
    .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:16px 16px 6px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      color:var(--pink);
      font-weight:900;
    }
    .subtitle{
      padding:0 16px 12px;
      color:var(--muted);
      font-size:13px;
    }
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    input[type="text"]::placeholder{color:#aaa;}

    button{
      width:100%;
      border:1px solid rgba(255,47,146,.35);
      background: linear-gradient(180deg, var(--pink), #ff3ea0);
      color:#fff;
      padding:12px 14px;
      border-radius:18px;
      cursor:pointer;
      font-weight:900;
      font-size:18px;
      transition:transform .05s ease, filter .15s ease;
      margin-top:14px;
    }
    button:hover{filter:brightness(.98)}
    button:active{transform:translateY(1px)}
    button:disabled{opacity:.55; cursor:not-allowed}

    .wheelArea{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:12px 12px 16px;
      text-align:center;
    }
    .wheelBox{
      position:relative;
      width:340px;
      height:340px;
      margin:6px auto 10px;
      max-width: 92vw;
      max-height: 92vw;
    }
    canvas{
      width:100%;
      height:100%;
      border-radius:50%;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 18px 55px rgba(0,0,0,.20);
      display:block;
    }
    .pointer{
      position:absolute;
      top:-10px;
      left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-bottom:30px solid #111;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.35));
    }

    .result{
      width:min(520px, 95%);
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
      margin-top:8px;
      box-shadow: 0 12px 35px rgba(0,0,0,.10);
      font-size:14px;
      line-height:1.35;
      text-align:left;
    }
    .result strong{color:var(--pink)}
    .small{color:var(--muted); font-size:12px;}
    .warn{
      color:#111;
      background: rgba(255,209,230,.75);
      border:1px solid rgba(255,47,146,.25);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      margin-top:10px;
      display:none;
    }
    .warn.show{display:block;}

    .prizeList{
      margin:10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .prizeItem{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .prizeItem b{color:#111}
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(255,47,146,.10);
      border:1px solid rgba(255,47,146,.20);
      color: var(--pink);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Inputs + fixed prizes -->
    <div class="card">
      <div class="title">
        <h1>üíñ SPIN MY WHEEL</h1>
        <span class="pill" id="modelBadge">Modelo</span>
      </div>
      <div class="subtitle">
        Ruleta con 8 premios ¬∑ el fan no puede editar nada
      </div>

      <div class="pad">
        <label>Nombre del fan (obligatorio)</label>
        <input id="fanName" type="text" placeholder="Ej: Juan P√©rez" />

        <label>Nombre del modelo (obligatorio)</label>
        <input id="modelName" type="text" placeholder="Ej: Iliana" />

        <div class="warn" id="warnBox">‚ö†Ô∏è Completa el nombre del fan y el del modelo antes de girar.</div>

        <button id="spinBtn">üé° Girar y enviar</button>

        <label style="margin-top:18px;">Premios</label>
        <ul class="prizeList" id="prizeList"></ul>

        <div class="small" style="margin-top:12px;">
          *Al terminar el giro, el resultado se env√≠a autom√°ticamente al grupo de Telegram.
        </div>
      </div>
    </div>

    <!-- Right: Wheel + Result -->
    <div class="card">
      <div class="wheelArea">
        <div class="wheelBox">
          <div class="pointer"></div>
          <canvas id="wheel" width="800" height="800"></canvas>
        </div>

        <div class="result" id="resultBox">
          Resultado: <strong>‚Äî</strong><br/>
          <span class="small">Escribe los nombres y gira.</span>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  const TELEGRAM_ENDPOINT = "https://ruleta-modelo.vercel.app/api/telegram";

  // Premios fijos (solo enumerados + emoji provocativo)
  const PRIZES = [
    "Premio 1 üòà",
    "Premio 2 üî•",
    "Premio 3 üí¶",
    "Premio 4 üçë",
    "Premio 5 üòè",
    "Premio 6 üëÖ",
    "Premio 7 üíã",
    "Premio 8 üéÅ"
  ];

  // ===== DOM =====
  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");

  const fanName = document.getElementById("fanName");
  const modelName = document.getElementById("modelName");
  const modelBadge = document.getElementById("modelBadge");

  const prizeList = document.getElementById("prizeList");
  const resultBox = document.getElementById("resultBox");
  const warnBox = document.getElementById("warnBox");
  const spinBtn = document.getElementById("spinBtn");

  // ===== State =====
  let rotation = 0;      // radians
  let spinning = false;

  // Init
  renderPrizeList();
  drawWheel();
  modelName.addEventListener("input", () => {
    modelBadge.textContent = (modelName.value || "").trim() || "Modelo";
  });

  spinBtn.addEventListener("click", () => spin());

  function renderPrizeList(){
    prizeList.innerHTML = "";
    PRIZES.forEach((p, idx) => {
      const li = document.createElement("li");
      li.className = "prizeItem";
      li.innerHTML = `<b>${escapeHtml(p)}</b><span class="pill">${idx+1}/8</span>`;
      prizeList.appendChild(li);
    });
  }

  async function sendToTelegram(record){
    try{
      const r = await fetch(TELEGRAM_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          fan: record.fan,
          model: record.model,
          prize: record.prize,
          datetime: record.datetime,
          note: record.note || ""
        })
      });

      if (!r.ok){
        const t = await r.text();
        console.error("Telegram endpoint error:", r.status, t);
      }
    }catch(e){
      console.error("No se pudo enviar a Telegram:", e);
    }
  }

  function spin(){
    if (spinning) return;

    const fan = (fanName.value || "").trim();
    const model = (modelName.value || "").trim();

    if (!fan || !model){
      warnBox.classList.add("show");
      if (!fan) fanName.focus();
      else modelName.focus();
      return;
    }
    warnBox.classList.remove("show");

    spinning = true;
    spinBtn.disabled = true;

    // Animate: 4-7 turns + random
    const fullTurns = randInt(4, 7);
    const extra = Math.random() * Math.PI * 2;
    const startRot = rotation;
    const endRot = rotation + fullTurns * Math.PI * 2 + extra;
    const duration = randInt(2600, 3400);
    const t0 = performance.now();

    function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

    function frame(now){
      const t = Math.min(1, (now - t0) / duration);
      rotation = startRot + (endRot - startRot) * easeOutCubic(t);
      drawWheel();

      if (t < 1) requestAnimationFrame(frame);
      else {
        rotation = endRot;
        drawWheel();

        const winIdx = getWinnerIndex(PRIZES.length);
        const winText = PRIZES[winIdx];

        const stamp = new Date().toLocaleString();
        const record = { datetime: stamp, fan, model, prize: winText, note: "" };

        resultBox.innerHTML =
          `Resultado: <strong>${escapeHtml(winText)}</strong><br/>
           <span class="small">Fan: ${escapeHtml(fan)} ¬∑ Modelo: ${escapeHtml(model)} ¬∑ ${escapeHtml(stamp)}</span>`;

        // ‚úÖ Enviar a Telegram autom√°ticamente
        sendToTelegram(record);

        spinning = false;
        spinBtn.disabled = false;
      }
    }
    requestAnimationFrame(frame);
  }

  // ===== Wheel drawing =====
  function drawWheel(){
    const W = canvas.width, H = canvas.height;
    const cx = W/2, cy = H/2;
    const radius = Math.min(W,H) * 0.43;

    ctx.clearRect(0,0,W,H);
    ctx.save();
    ctx.translate(cx, cy);

    // outer glow
    ctx.beginPath();
    ctx.arc(0,0,radius+30,0,Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.28)";
    ctx.fill();

    const n = PRIZES.length;
    const slice = (Math.PI*2)/n;

    for(let i=0;i<n;i++){
      const start = rotation + i*slice;
      const end = start + slice;

      // alternate pinks
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,radius,start,end);
      ctx.closePath();
      ctx.fillStyle = (i%2===0) ? "rgba(255,47,146,0.85)" : "rgba(255,111,177,0.75)";
      ctx.fill();

      // border
      ctx.strokeStyle = "rgba(255,255,255,0.55)";
      ctx.lineWidth = 4;
      ctx.stroke();

      // label (solo 1-8)
      const mid = (start+end)/2;
      ctx.save();
      ctx.rotate(mid);
      ctx.textAlign = "right";
      ctx.fillStyle = "rgba(255,255,255,0.98)";
      ctx.font = "900 44px Arial";
      ctx.fillText(String(i+1), radius - 18, 16);
      ctx.restore();
    }

    // center cap
    ctx.beginPath();
    ctx.arc(0,0,92,0,Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.06)";
    ctx.lineWidth = 6;
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = "900 34px Arial";
    ctx.textAlign = "center";
    ctx.fillText("SPIN", 0, 12);

    ctx.restore();
  }

  function getWinnerIndex(n){
    // pointer at top => angle -pi/2
    const pointer = -Math.PI/2;
    let a = (pointer - rotation) % (Math.PI*2);
    if (a < 0) a += Math.PI*2;
    const slice = (Math.PI*2)/n;
    return Math.floor(a / slice);
  }

  // ===== Utils =====
  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
</script>
</body>
</html>
